<!DOCTYPE html>
<html>

<head>
    <title>My Orders</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <!-- NAVBAR -->
    <nav class="top-nav">
        <div class="nav-left">
            <span class="brand">ClinicCare</span>
        </div>
        <div class="nav-right">
            <a href="dashboard.html">Dashboard</a>
            <a href="appointments.html">Appointments</a>
            <a href="medicines.html">Medicines</a>
            <a href="cart.html">Cart</a>
            <a href="orders.html">Orders</a>
            <a href="profile.html">Profile</a>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

    </nav>

    <!-- PAGE CONTENT -->
    <main class="page-content">

        <h2>My Orders</h2>
        <p style="color:#6b7280; margin-bottom:24px;">
            Track your medicine orders and their current status.
        </p>

        <div id="ordersContainer" class="container">
            <!-- Orders will be loaded here -->
        </div>
    </main>

    <script>
        const token = localStorage.getItem("token");

        async function loadOrders() {
            const response = await fetch("http://localhost:8080/orders", {
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            if (!response.ok) {
                alert("Failed to load orders");
                return;
            }

            const orders = await response.json();
            const container = document.getElementById("ordersContainer");
            container.innerHTML = "";

            if (orders.length === 0) {
                container.innerHTML = "<p>You have no orders yet.</p>";
                return;
            }

            orders.forEach(order => {
                const card = document.createElement("div");
                card.className = "card";

                let actionButton = "";

                if (order.status === "PAID") {
                    actionButton = `
            <button class="secondary-btn"
                onclick="updateStatus(${order.id}, 'dispatch')">
                Mark as Dispatched
            </button>`;
                } else if (order.status === "DISPATCHED") {
                    actionButton = `
            <button class="secondary-btn"
                onclick="updateStatus(${order.id}, 'deliver')">
                Mark as Delivered
            </button>`;
                }

                card.innerHTML = `
        <h3>Order #${order.id}</h3>
        <p><strong>Total:</strong> â‚¹${order.totalAmount}</p>
        <p>
        <strong>Status:</strong>
        <span class="badge ${getStatusBadge(order.status)}">
            ${order.status}
            </span>
        </p>

        <p><strong>Placed On:</strong>
            ${new Date(order.createdAt).toLocaleString()}
        </p>
        ${actionButton}
    `;

                container.appendChild(card);
            });
        }

        function logout() {
            localStorage.removeItem("token");
            window.location.href = "index.html";
        }
        function getStatusBadge(status) {
            switch (status) {
                case "CREATED":
                    return "badge-info";
                case "PAID":
                    return "badge-success";
                case "DISPATCHED":
                    return "badge-warning";
                case "DELIVERED":
                    return "badge-success";
                case "CANCELLED":
                    return "badge-danger";
                default:
                    return "badge-info";
            }
        }


        loadOrders();
        async function updateStatus(orderId, action) {
            const response = await fetch(
                `http://localhost:8080/orders/${orderId}/${action}`,
                {
                    method: "PUT",
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                }
            );

            if (!response.ok) {
                alert("Status update failed");
                return;
            }

            loadOrders();
        }

    </script>

</body>

</html>